<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Klan RPG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* TEMEL AYARLAR */
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER (√úst Bilgi) */
        .header {
            height: 60px; background: #111; border-bottom: 2px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 100;
        }
        .res-box { display: flex; flex-direction: column; align-items: center; }
        .res-val { font-weight: bold; font-size: 14px; }
        .res-label { font-size: 10px; color: #888; }
        .gold-txt { color: #ffd700; }
        
        /* XP BARI */
        .xp-container { width: 100%; height: 4px; background: #333; position: relative; }
        .xp-fill { height: 100%; background: #00bfff; width: 0%; transition: width 0.5s; box-shadow: 0 0 10px #00bfff; }

        /* SAYFA YAPISI (√ñrt√º≈ümeyi √∂nler) */
        .page-container { flex: 1; position: relative; overflow: hidden; }
        .page { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; /* Varsayƒ±lan gizli */
            flex-direction: column; overflow-y: auto; padding-bottom: 80px;
            background: #050505;
        }
        .page.active { display: flex; animation: fadeIn 0.3s; }

        /* ARENA TASARIMI */
        .arena-bg {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #2a0e0e 0%, #000 100%);
        }
        .floor-badge {
            background: #4a0000; color: #ffcccc; padding: 5px 15px; border-radius: 20px; 
            border: 1px solid #ff4444; font-weight: bold; margin-bottom: 20px; font-size: 14px;
        }
        .monster-container {
            width: 240px; height: 240px; position: relative; display: flex; align-items: center; justify-content: center;
        }
        .monster-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 20px rgba(255,0,0,0.2)); transition: transform 0.1s; }
        
        /* MARKET TASARIMI */
        .market-header { text-align: center; padding: 20px; background: linear-gradient(to bottom, #1a1a00, #000); border-bottom: 1px solid #333; }
        .npc-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid #ffd700; background: #000; object-fit: cover; }
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .item-card { background: #151515; border: 1px solid #333; border-radius: 10px; padding: 10px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .item-img { width: 64px; height: 64px; object-fit: contain; margin-bottom: 5px; }
        .btn-buy { background: #ffd700; color: #000; border: none; width: 100%; padding: 8px; border-radius: 5px; font-weight: bold; margin-top: auto; cursor: pointer; }
        .btn-buy:disabled { background: #333; color: #666; }

        /* PROFƒ∞L TASARIMI */
        .profile-header { padding: 30px; text-align: center; background: linear-gradient(to bottom, #001a33, #000); }
        .stat-row { display: flex; justify-content: space-around; margin-top: 20px; }
        .stat-box { background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; width: 45%; text-align: center; border: 1px solid #333; }

        /* SAVA≈û BUTONU */
        .btn-fight {
            margin: 20px; width: calc(100% - 40px); height: 60px;
            background: linear-gradient(90deg, #ff3333, #990000); border: none; border-radius: 15px;
            color: white; font-size: 22px; font-weight: 900; letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.4); cursor: pointer;
        }
        .btn-fight:active { transform: scale(0.96); }

        /* ALT MEN√ú */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: #111;
            border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center; z-index: 200;
        }
        .nav-btn { flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; font-size: 11px; }
        .nav-btn.active { color: #fff; background: linear-gradient(to top, #222, transparent); border-top: 2px solid #ffd700; }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }

        /* RESULT POPUP (MODAL) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.2s;
        }
        .modal-box {
            background: #1a1a1a; width: 80%; padding: 25px; border-radius: 20px; text-align: center;
            border: 2px solid #444; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .modal-title { font-size: 32px; font-weight: 900; margin-bottom: 10px; }
        .modal-msg { font-size: 16px; color: #ccc; margin-bottom: 20px; }
        .modal-reward { font-size: 18px; color: #ffd700; font-weight: bold; margin-bottom: 25px; padding: 10px; background: #000; border-radius: 10px; }
        .btn-close { background: #fff; color: #000; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; font-size: 16px; width: 100%; }
        
        /* Animasyonlar */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.5); } to { transform: scale(1); } }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-10px);} 75% {transform: translateX(10px);} }

    </style>
</head>
<body>

    <div class="xp-container"><div id="xp-bar" class="xp-fill"></div></div>

    <div class="header">
        <div class="res-box"><span class="res-val gold-txt" id="head-gold">0</span><span class="res-label">ALTIN</span></div>
        <div class="res-box"><span class="res-val" style="color:#00bfff" id="head-lvl">1</span><span class="res-label">SEVƒ∞YE</span></div>
        <div class="res-box"><span class="res-val" style="color:#0f0">‚àû</span><span class="res-label">ENERJƒ∞</span></div>
    </div>

    <div class="page-container">
        
        <div id="page-arena" class="page active">
            <div class="arena-bg">
                <div class="floor-badge" id="arena-floor">Zƒ∞NDAN Y√úKLENƒ∞YOR...</div>
                
                <div class="monster-container">
                    <img id="monster-img" class="monster-img" src="" alt="D√º≈üman">
                </div>

                <div style="margin-top: 20px; color: #888; font-size: 12px;">Saldƒ±rmak i√ßin butona bas üëá</div>
            </div>
            <button class="btn-fight" id="btn-fight" onclick="savas()">‚öîÔ∏è SALDIR</button>
        </div>

        <div id="page-market" class="page">
            <div class="market-header">
                <img src="https://cdn-icons-png.flaticon.com/512/4042/4042356.png" class="npc-img">
                <h2 style="color:#ffd700; margin: 10px 0 0 0;">T√úCCAR</h2>
                <div style="font-size:12px; color:#aaa;">"En iyi silahlar bende!"</div>
            </div>
            <div id="market-list" class="market-grid"></div>
        </div>

        <div id="page-profile" class="page">
            <div class="profile-header">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" style="width:80px; filter: invert(1);">
                <h2 id="prof-name">Sava≈ü√ßƒ±</h2>
                <div style="color:#888;" id="prof-klan">...</div>
                
                <div class="stat-row">
                    <div class="stat-box">
                        <div style="color:#ff4444; font-size:24px; font-weight:bold;" id="prof-atk">0</div>
                        <div style="font-size:10px;">SALDIRI</div>
                    </div>
                    <div class="stat-box">
                        <div style="color:#4444ff; font-size:24px; font-weight:bold;" id="prof-def">0</div>
                        <div style="font-size:10px;">SAVUNMA</div>
                    </div>
                </div>
            </div>
            <h3 style="padding: 0 15px;">ENVANTER</h3>
            <div id="inventory-list" style="padding: 0 15px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" onclick="setTab('arena', this)">
            <span class="nav-icon">‚öîÔ∏è</span> Arena
        </div>
        <div class="nav-btn" onclick="setTab('market', this)">
            <span class="nav-icon">üõí</span> Market
        </div>
        <div class="nav-btn" onclick="setTab('profile', this)">
            <span class="nav-icon">üë§</span> Profil
        </div>
    </div>

    <div id="result-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-title" class="modal-title">ZAFER!</div>
            <div id="modal-msg" class="modal-msg">D√º≈ümanƒ± yendin.</div>
            <div id="modal-reward" class="modal-reward">+100 Altƒ±n</div>
            <button class="btn-close" onclick="closeModal()">DEVAM ET</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const telegramId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;

        // Canavarlar
        const MONSTERS = [
            "https://cdn-icons-png.flaticon.com/512/1236/1236412.png", // 1 - Slime
            "https://cdn-icons-png.flaticon.com/512/3063/3063066.png", // 2 - Spider
            "https://cdn-icons-png.flaticon.com/512/1998/1998610.png", // 3 - Goblin
            "https://cdn-icons-png.flaticon.com/512/1205/1205510.png", // 4 - Skeleton
            "https://cdn-icons-png.flaticon.com/512/1236/1236413.png", // 5 - Dark Knight
            "https://cdn-icons-png.flaticon.com/512/3135/3135789.png", // 6 - Golem
            "https://cdn-icons-png.flaticon.com/512/3305/3305963.png"  // 7+ Dragon
        ];

        let playerData = {};

        // Sayfa Ge√ßi≈üi
        function setTab(tabName, btnElement) {
            // T√ºm sayfalarƒ± gizle
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // Se√ßileni a√ß
            document.getElementById('page-' + tabName).classList.add('active');
            
            // Buton rengini ayarla
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            if(tabName === 'market') loadMarket();
        }

        async function init() {
            if(!telegramId) return alert("Telegram'dan girin.");
            const res = await fetch(`/api/user/${telegramId}`);
            const data = await res.json();
            playerData = data;
            updateUI();
        }

        function updateUI() {
            // Header
            document.getElementById('head-gold').innerText = playerData.altin;
            document.getElementById('head-lvl').innerText = playerData.seviye;
            
            // XP Barƒ±
            const xpPercent = Math.min(100, (playerData.xp / playerData.gerekenXp) * 100);
            document.getElementById('xp-bar').style.width = xpPercent + '%';

            // Arena
            let floor = playerData.zindanSeviyesi;
            document.getElementById('arena-floor').innerText = `Zƒ∞NDAN KAT ${floor}`;
            // Canavar resmi (Kat sayƒ±sƒ±na g√∂re d√∂ng√º)
            let mIndex = (floor - 1) % MONSTERS.length;
            document.getElementById('monster-img').src = MONSTERS[mIndex];

            // Profil
            document.getElementById('prof-name').innerText = playerData.isim;
            document.getElementById('prof-klan').innerText = playerData.klan || "Yok";
            document.getElementById('prof-atk').innerText = playerData.saldiri;
            document.getElementById('prof-def').innerText = playerData.savunma;
            
            // Envanter
            const invList = document.getElementById('inventory-list');
            invList.innerHTML = "";
            playerData.envanter.forEach(id => {
                invList.innerHTML += `<div style="background:#222; padding:5px; border-radius:5px; border:1px solid #444;">‚úÖ ${id}</div>`;
            });
        }

        async function loadMarket() {
            const res = await fetch('/api/market');
            const items = await res.json();
            const list = document.getElementById('market-list');
            list.innerHTML = "";
            
            items.forEach(item => {
                const owned = playerData.envanter.includes(item.id);
                list.innerHTML += `
                    <div class="item-card">
                        <img src="${item.img}" class="item-img">
                        <div style="font-weight:bold; margin-bottom:5px;">${item.ad}</div>
                        <div style="font-size:11px; color:#aaa;">+${item.deger} G√ú√á</div>
                        <button class="btn-buy" onclick="buyItem('${item.id}')" ${owned ? 'disabled' : ''} style="${owned ? 'background:#333' : ''}">
                            ${owned ? 'ALINDI' : item.fiyat + ' üí∞'}
                        </button>
                    </div>
                `;
            });
        }

        async function buyItem(itemId) {
            tg.HapticFeedback.selectionChanged();
            const res = await fetch('/api/satin-al', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ telegramId, itemId })
            });
            const data = await res.json();
            if(data.success) {
                init(); // Verileri g√ºncelle
                loadMarket(); // Butonu g√ºncelle
                tg.showPopup({title: 'Ba≈üarƒ±lƒ±', message: data.mesaj});
            } else {
                tg.showAlert(data.error);
            }
        }

        async function savas() {
            const btn = document.getElementById('btn-fight');
            const img = document.getElementById('monster-img');
            
            btn.disabled = true;
            img.classList.add('shake');
            tg.HapticFeedback.impactOccurred('heavy');

            setTimeout(async () => {
                img.classList.remove('shake');
                
                const res = await fetch('/api/savas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ telegramId })
                });
                const data = await res.json();
                
                // POPUP G√ñSTER
                showModal(data);
                
                // Verileri g√ºncelle
                playerData.altin = data.yeniData.altin;
                playerData.xp = data.yeniData.xp;
                playerData.seviye = data.yeniData.lvl;
                playerData.zindanSeviyesi = data.yeniData.zindan;
                playerData.gerekenXp = data.yeniData.gerekenXp;
                updateUI();
                
                btn.disabled = false;
            }, 600);
        }

        // Modal (Sonu√ß Penceresi) ƒ∞≈ülemleri
        function showModal(data) {
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('modal-title');
            const msg = document.getElementById('modal-msg');
            const reward = document.getElementById('modal-reward');

            modal.style.display = 'flex';
            
            if(data.durum === 'win') {
                title.innerText = data.baslik;
                title.style.color = '#00ff00';
                msg.innerText = data.mesaj + (data.ozel ? '\n' + data.ozel : '');
                reward.innerText = data.odul;
                reward.style.display = 'block';
            } else {
                title.innerText = data.baslik;
                title.style.color = '#ff0000';
                msg.innerText = data.mesaj;
                reward.style.display = 'none';
            }
        }

        function closeModal() {
            document.getElementById('result-modal').style.display = 'none';
        }

        // Ba≈ülangƒ±√ß
        init();
    </script>
</body>
</html>