<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Klan RPG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* GENEL AYARLAR */
        body { margin: 0; background: #050505; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* √úST PANEL */
        .header {
            background: rgba(20, 20, 20, 0.95);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .stat-badge { font-size: 13px; font-weight: bold; background: #222; padding: 5px 10px; border-radius: 15px; border: 1px solid #444; }
        .gold { color: #ffd700; border-color: #ffd700; }
        .lvl { color: #00e5ff; border-color: #00e5ff; }

        /* ƒ∞√áERƒ∞K ALANI (Scroll Edilebilir) */
        .content { flex: 1; overflow-y: auto; position: relative; padding-bottom: 80px; /* Men√º payƒ± */ }
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }

        /* ARENA SAHNESƒ∞ */
        .arena-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;
            background: radial-gradient(circle, #1a0b0b 0%, #000000 90%);
        }
        .monster-card {
            position: relative;
            width: 220px; height: 220px;
            display: flex; align-items: center; justify-content: center;
        }
        .monster-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.3)); transition: transform 0.1s; }
        .floor-badge { position: absolute; top: -40px; background: #330000; padding: 5px 20px; border-radius: 20px; border: 1px solid #ff0000; font-weight: bold; font-size: 14px; color: #ffaaaa; }
        
        /* MARKET GRID */
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .item-card {
            background: #151515; padding: 15px; border-radius: 12px; text-align: center; position: relative;
            border: 2px solid #333; transition: transform 0.2s;
        }
        .item-card:active { transform: scale(0.95); }
        .item-img { font-size: 40px; margin-bottom: 10px; display: block; }
        .item-name { font-size: 14px; font-weight: bold; margin-bottom: 5px; height: 35px; display: flex; align-items: center; justify-content: center; }
        .item-price { color: #ffd700; font-size: 13px; font-weight: bold; margin-bottom: 10px; }
        .btn-buy {
            width: 100%; padding: 8px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
            background: #ffd700; color: #000;
        }
        /* Nadirlik Renkleri */
        .rarity-1 { border-color: #555; } /* Normal */
        .rarity-2 { border-color: #007bff; box-shadow: 0 0 10px rgba(0, 123, 255, 0.2); } /* Nadir */
        .rarity-3 { border-color: #a020f0; box-shadow: 0 0 10px rgba(160, 32, 240, 0.3); } /* Destansƒ± */
        .rarity-4 { border-color: #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); background: linear-gradient(145deg, #1a1a00, #000); } /* Efsanevi */

        /* ALT MEN√ú (Sabit) */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: #111; border-top: 1px solid #333;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #666; font-size: 11px; font-weight: bold; cursor: pointer; width: 100%; height: 100%;
        }
        .nav-item.active { color: #ffd700; background: linear-gradient(to top, #1a1a00, transparent); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }

        /* SAVA≈û BUTONU */
        .btn-main-action {
            width: 80%; padding: 18px; border-radius: 50px; border: none;
            background: linear-gradient(180deg, #ff3333 0%, #990000 100%);
            color: white; font-size: 20px; font-weight: 900; letter-spacing: 1px;
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.4); margin-top: 30px;
            cursor: pointer; transition: all 0.1s;
        }
        .btn-main-action:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(255,0,0,0.2); }
        .btn-main-action:disabled { background: #444; color: #888; box-shadow: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0% { transform: translate(0,0); } 25% { transform: translate(-5px, 0); } 75% { transform: translate(5px, 0); } 100% { transform: translate(0,0); } }
        .anim-shake { animation: shake 0.4s ease-in-out; }
    </style>
</head>
<body>

    <div class="header">
        <div class="stat-badge gold">üí∞ <span id="ui-gold">0</span></div>
        <div class="stat-badge lvl">‚öîÔ∏è Lv.<span id="ui-lvl">1</span></div>
        <div class="stat-badge" style="color:#0f0; border-color:#0f0">‚ö° ‚àû</div>
    </div>

    <div class="content">
        
        <div id="page-arena" class="page active arena-container">
            <div class="floor-badge" id="ui-floor">Zƒ∞NDAN KAT 1</div>
            
            <div class="monster-card">
                <img id="monster-img" class="monster-img" src="" alt="Monster">
            </div>

            <button id="btn-savas" class="btn-main-action" onclick="savasYap()">SALDIR!</button>
            <div id="log-msg" style="margin-top:15px; color:#aaa; font-size:14px; height:20px;">D√º≈üman seni bekliyor...</div>
        </div>

        <div id="page-market" class="page">
            <h2 style="text-align:center; color:#ffd700; margin-bottom:20px;">Sƒ∞LAH T√úCCARI</h2>
            <div id="market-list" class="market-grid">Y√ºkleniyor...</div>
        </div>

        <div id="page-profil" class="page">
            <div style="text-align:center; margin-top:20px;">
                <div style="font-size:50px; margin-bottom:10px;">üë§</div>
                <h2 id="p-name">Sava≈ü√ßƒ±</h2>
                <div style="color:#888;" id="p-klan">Klansƒ±z</div>
                
                <div style="display:flex; justify-content:center; gap:20px; margin:20px 0;">
                    <div style="background:#222; padding:15px; border-radius:10px; width:100px;">
                        <div style="color:#ff5555; font-size:20px; font-weight:bold;" id="p-atk">0</div>
                        <div style="font-size:12px; color:#aaa;">SALDIRI</div>
                    </div>
                    <div style="background:#222; padding:15px; border-radius:10px; width:100px;">
                        <div style="color:#5555ff; font-size:20px; font-weight:bold;" id="p-def">0</div>
                        <div style="font-size:12px; color:#aaa;">SAVUNMA</div>
                    </div>
                </div>

                <h3 style="text-align:left; margin-left:10px; border-bottom:1px solid #333; padding-bottom:5px;">ENVANTER</h3>
                <div id="p-inv" style="display:flex; flex-wrap:wrap; gap:10px; padding:10px;"></div>
            </div>
        </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="navTo('arena', this)">
            <div class="nav-icon">‚öîÔ∏è</div>
            <div>Arena</div>
        </div>
        <div class="nav-item" onclick="navTo('market', this)">
            <div class="nav-icon">üõí</div>
            <div>Market</div>
        </div>
        <div class="nav-item" onclick="navTo('profil', this)">
            <div class="nav-icon">üë§</div>
            <div>Profil</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const telegramId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;

        // CANAVAR G√ñRSELLERƒ∞ (Kat 1-10)
        const MONSTERS = [
            "https://cdn-icons-png.flaticon.com/512/2830/2830238.png", // 1 - Slime
            "https://cdn-icons-png.flaticon.com/512/3063/3063066.png", // 2 - √ñr√ºmcek
            "https://cdn-icons-png.flaticon.com/512/1998/1998610.png", // 3 - Goblin
            "https://cdn-icons-png.flaticon.com/512/1205/1205510.png", // 4 - ƒ∞skelet
            "https://cdn-icons-png.flaticon.com/512/1236/1236413.png", // 5 - Kara ≈û√∂valye
            "https://cdn-icons-png.flaticon.com/512/2102/2102914.png", // 6 - B√ºy√ºc√º
            "https://cdn-icons-png.flaticon.com/512/3135/3135789.png", // 7 - Golem
            "https://cdn-icons-png.flaticon.com/512/3062/3062650.png", // 8 - Hayalet
            "https://cdn-icons-png.flaticon.com/512/3305/3305963.png", // 9 - Ejderha Yavrusu
            "https://cdn-icons-png.flaticon.com/512/2153/2153072.png"  // 10 - BOSS (Ejderha)
        ];

        let playerData = {};

        // Sayfa Deƒüi≈ütirme Fonksiyonu
        function navTo(pageId, element) {
            // T√ºm sayfalarƒ± gizle
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // ƒ∞stenen sayfayƒ± a√ß
            document.getElementById('page-' + pageId).classList.add('active');
            
            // Men√º aktifliƒüini g√ºncelle
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            element.classList.add('active');

            if(pageId === 'market') loadMarket();
        }

        async function init() {
            if(!telegramId) return alert("Telegram'dan girin.");
            const res = await fetch(`/api/user/${telegramId}`);
            const data = await res.json();
            playerData = data;
            updateUI();
        }

        function updateUI() {
            // Header
            document.getElementById('ui-gold').innerText = playerData.altin;
            document.getElementById('ui-lvl').innerText = playerData.seviye;
            
            // Arena
            let stage = playerData.zindanSeviyesi;
            if(stage > 10) stage = 10;
            document.getElementById('ui-floor').innerText = stage === 10 ? "üëë BOSS KATI" : `Zƒ∞NDAN KAT ${stage}`;
            document.getElementById('ui-floor').style.color = stage === 10 ? "#ff5555" : "#ffaaaa";
            document.getElementById('monster-img').src = MONSTERS[stage - 1];

            // Profil
            document.getElementById('p-name').innerText = playerData.isim;
            document.getElementById('p-klan').innerText = playerData.klan || "Yok";
            document.getElementById('p-atk').innerText = playerData.saldiri;
            document.getElementById('p-def').innerText = playerData.savunma;
            
            const invDiv = document.getElementById('p-inv');
            invDiv.innerHTML = "";
            playerData.envanter.forEach(item => {
                invDiv.innerHTML += `<div style="font-size:25px; background:#222; padding:10px; border-radius:8px;">${getItemIcon(item)}</div>`;
            });
        }

        function getItemIcon(id) {
            if(id.includes('kilic')) return 'üó°Ô∏è';
            if(id.includes('zirh')) return 'üõ°Ô∏è';
            if(id.includes('asa')) return 'üî•';
            if(id.includes('hancer')) return 'üî™';
            return 'üì¶';
        }

        async function loadMarket() {
            const res = await fetch('/api/market');
            const items = await res.json();
            const list = document.getElementById('market-list');
            list.innerHTML = "";
            
            items.forEach(item => {
                const owned = playerData.envanter.includes(item.id);
                list.innerHTML += `
                    <div class="item-card rarity-${item.rarity}">
                        <div class="item-img">${item.resim}</div>
                        <div class="item-name">${item.ad}</div>
                        <div style="font-size:11px; color:#aaa; margin-bottom:5px;">+${item.deger} G√º√ß</div>
                        <div class="item-price">${item.fiyat} üí∞</div>
                        <button class="btn-buy" onclick="buyItem('${item.id}')" ${owned ? 'disabled style="background:#444; color:#888;"' : ''}>
                            ${owned ? 'SAHƒ∞PSƒ∞N' : 'SATIN AL'}
                        </button>
                    </div>
                `;
            });
        }

        async function buyItem(itemId) {
            tg.HapticFeedback.selectionChanged();
            const res = await fetch('/api/satin-al', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ telegramId, itemId })
            });
            const data = await res.json();
            if(data.success) {
                tg.showPopup({ title: 'Hayƒ±rlƒ± Olsun!', message: data.mesaj });
                init();
                loadMarket(); // Listeyi yenile (butonu pasif yapmak i√ßin)
            } else {
                tg.showAlert(data.error);
            }
        }

        async function savasYap() {
            const btn = document.getElementById('btn-savas');
            const img = document.getElementById('monster-img');
            
            btn.disabled = true;
            btn.innerText = "üí•";
            img.classList.add('anim-shake');
            tg.HapticFeedback.impactOccurred('heavy');

            setTimeout(async () => {
                img.classList.remove('anim-shake');
                const res = await fetch('/api/savas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ telegramId })
                });
                const data = await res.json();
                
                document.getElementById('log-msg').innerText = data.mesaj;
                
                if(data.kazandimi) {
                    document.getElementById('log-msg').style.color = "#0f0";
                    tg.showPopup({ title: 'ZAFER!', message: data.detay });
                } else {
                    document.getElementById('log-msg').style.color = "#f00";
                }
                
                playerData.altin = data.yeniAltin;
                playerData.xp = data.yeniXp;
                playerData.zindanSeviyesi = data.zindan;
                updateUI();

                btn.disabled = false;
                btn.innerText = "SALDIR!";
            }, 500);
        }

        // Ba≈ülat
        init();
    </script>
</body>
</html>